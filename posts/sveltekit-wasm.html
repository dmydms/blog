<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="content-security-policy" content=""><title>스벨트킷 + WASM :: 공부왕 김공부</title><link rel="alternate" type="application/rss+xml" title="RSS" href="/rss.xml" data-svelte="svelte-1bmcg5l"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" data-svelte="svelte-1bmcg5l"><script data-svelte="svelte-1bmcg5l">;(function (w, d, s, l, i) {
      w[l] = w[l] || []
      w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' })
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : ''
      j.async = true
      j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl
      f.parentNode.insertBefore(j, f)
    })(window, document, 'script', 'dataLayer', 'GTM-PHD2KSF')
  </script><meta name="description" content="스벨트킷에서 러스트로 만든 WASM 코드를 실행하는 방법" data-svelte="svelte-1etj527">
	<link rel="stylesheet" href="/_app/assets/pages/__layout.svelte-a310949f.css">
	<link rel="stylesheet" href="/_app/assets/LayoutDefault-f057f759.css">
	<link rel="modulepreload" href="/_app/start-45cd698a.js">
	<link rel="modulepreload" href="/_app/chunks/index-40d1c8d0.js">
	<link rel="modulepreload" href="/_app/chunks/preload-helper-e4860ae8.js">
	<link rel="modulepreload" href="/_app/chunks/singletons-d1fb5791.js">
	<link rel="modulepreload" href="/_app/pages/__layout.svelte-7800c35d.js">
	<link rel="modulepreload" href="/_app/chunks/conf-cbd2bb0f.js">
	<link rel="modulepreload" href="/_app/pages/posts/sveltekit-wasm.md-2f5a5957.js">
	<link rel="modulepreload" href="/_app/chunks/LayoutDefault-8f32cd80.js">
  </head>
  <body>
    




<nav class="gnb svelte-1y5881k"><ul class="svelte-1y5881k"><li><a sveltekit:prefetch href="/">블로그 홈</a></li>
    <li><a sveltekit:prefetch href="/posts/about">소개</a></li></ul></nav>

<main>

<article class="post"><h1>스벨트킷 + WASM</h1>
  <p class="info svelte-1fq8f0d"><time>2022-04-03</time></p>
  <p>최신 브라우저들이 모두 웹어셈블리를 지원하기 때문에 전체 코드 중 성능이 특히 중요한 부분들을
웹어셈블리로 대체하는 사이트가 점차 늘고 있습니다. 이 글에서는 러스트로 간단한 웹어셈블리
코드를 만들고 이를 스벨트킷 사이트에서 호출하는 방법을 설명합니다.</p>
<h2 id="웹어셈블리란"><a href="#웹어셈블리란">웹어셈블리란</a></h2>
<p><a href="https://webassembly.org/" rel="nofollow">웹어셈블리WemAssembly</a>란 빠르게 전송할 수 있고 웹
브라우저에서 거의 네이티브 코드의 속도로 실행할 수 있는 작은 바이너리 파일입니다. 현대의 웹
브라우저들은 모두 웹어셈블리를 실행할 수 있는 가상 머신을 내장하고 있습니다.</p>
<p>자바스크립트가 초기에는 웹 브라우저에서만 실행되다가 요즘에는 NodeJS나 Deno 덕에 서버에서도
실행되는 것과 마찬가지로, 웹어셈블리도 처음에는 웹 브라우저에서만 실행이 됐으나 요즘에는
어디에서든 실행할 수 있도록 점차 확장되고 있습니다.</p>
<p>작고 빠르고 안전하며 다양한 언어로 작성할 수 있고 어디에서나 실행할 수 있기 때문에 점차 그
역할이 커지고 있습니다.</p>
<h2 id="러스트로-웹어셈블리-파일-만들기"><a href="#러스트로-웹어셈블리-파일-만들기">러스트로 웹어셈블리 파일 만들기</a></h2>
<p>웹어셈블리는 다양한 언어로 만들 수 있지만, 웹어셈블리를 만들 때 가장 인기있는 언어는
러스트입니다. 러스트는 컴파일러 및 각종 툴체인이 훌륭해서 개발 경험이 좋고 만들어진 WASM
파일의 크기도 매우 작은 편이라서 그렇습니다.</p>
<p>러스트로 웹어셈블리를 만들고 스벨트킷에서 호출하는 순서는 이렇습니다.</p>
<ol><li>러스트 프로젝트 셋업</li>
<li>코드 작성</li>
<li>웹어셈블리 빌드</li>
<li>스벨트킷에서 임포트하여 호출</li></ol>
<p>이 블로그는 CloudFlare Pages를 이용해서 빌드를 하고 있는데 아쉽게도 이 환경은 아직 러스트를
지원하지 않습니다. 따라서 웹어셈블리를 빌드하는 과정은 별도의 환경에서 진행하고, 빌드한
결과물만 가져와서 쓰는 방식으로 해야합니다.</p>
<p>웹어셈블리 프로젝트를 별도의 저장소로 만들어서 깃헙에 올리고 깃헙 액션즈Github Actions로
빌드를 하고, 기존의 블로그 프로젝트에서는 이 빌드 결과를 가져와서 쓰는 방식으로 분리를 하면
될 것 같습니다.</p>
<p>러스트 공식 웹사이트의 <a href="https://www.rust-lang.org/tools/install" rel="nofollow">안내</a>에 따라 러스트를
설치하세요. 그 다음 <a href="https://rustwasm.github.io/wasm-pack/installer/" rel="nofollow">wasm-pack</a>을
설치합니다. 이제 준비가 끝났습니다.</p>
<p>블로그 프로젝트의 상위 디렉터리(예를 들어 블로그 프로젝트가 <code>~/prjs/blog</code>라면 <code>~/prjs</code>)에서
다음 명령을 실행하면 <code>blogwasm</code> 디렉터리에 러스트 라이브러리 프로젝트가 만들어집니다.
<code>cargo new</code> 명령은 <code>npm init</code>과 유사한 역할을 합니다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">cargo new --lib blogwasm</code><!-- HTML_TAG_END --></pre>
<p>이 디렉터리로 이동한 뒤에 웹어셈블리 개발에 필요한 크레이트(crate: 러스트에서는 패키지를
크레이트라고 부릅니다)를 설치합니다. <code>cargo add</code> 명령은 <code>npm install</code>과 유사한 역할을
합니다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">cargo <span class="token function">add</span> wasm-bindgen</code><!-- HTML_TAG_END --></pre>
<p>위 명령을 실행하고 나면 <code>Cargo.toml</code> 파일과 <code>Cargo.lock</code> 파일에 관련 내용이 추가됩니다.
이 파일들은 노드JS의 <code>package.json</code> 파일 및 <code>package-lock.json</code> 파일과 유사한 역할을
합니다.</p>
<p><code>src/lib.rs</code> 파일의 내용을 아래와 같이 수정합니다. 아래 코드는
<a href="https://rustwasm.github.io/book/game-of-life/hello-world.html" rel="nofollow">The Rust Wasm Book</a>에서
참고하였습니다.</p>
<pre class="language-rust"><!-- HTML_TAG_START --><code class="language-rust"><span class="token comment">// 자바스크립트의 import와 유사</span>
<span class="token keyword">use</span> <span class="token namespace">wasm_bindgen<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">// 메모리 할당에 wee_alloc을 사용</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">"wee_alloc"</span>)]</span>
<span class="token attribute attr-name">#[global_allocator]</span>
<span class="token keyword">static</span> <span class="token constant">ALLOC</span><span class="token punctuation">:</span> <span class="token namespace">wee_alloc<span class="token punctuation">::</span></span><span class="token class-name">WeeAlloc</span> <span class="token operator">=</span> <span class="token namespace">wee_alloc<span class="token punctuation">::</span></span><span class="token class-name">WeeAlloc</span><span class="token punctuation">::</span><span class="token constant">INIT</span><span class="token punctuation">;</span>

<span class="token comment">// 자바스크립트의 alert()을 러스트에서 호출하기 위해 필요</span>
<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">alert</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 자바스크립트에서 호출할 수 있는 greet() 함수</span>
<span class="token attribute attr-name">#[wasm_bindgen]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greet</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">"Hello, &#123;&#125;!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>마지막으로, <code>Cargo.toml</code> 파일에 아래 내용을 추가해주세요. <code>cdylib</code> 타입은 원래 컴파일된
라이브러리를 C 또는 C++에 링크하기 위해 사용하는데(C Dynamic Library의 약자인 것 같아요),
웹어셈블리 개발에도 쓰입니다.</p>
<pre class="language-toml"><!-- HTML_TAG_START --><code class="language-toml"><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">crate-type</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"cdylib"</span><span class="token punctuation">]</span></code><!-- HTML_TAG_END --></pre>
<p>다음 명령을 실행하면 <code>pkg</code> 디렉터리 안에 웹어셈블리 파일이 만들어집니다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash">wasm-pack build --target web</code><!-- HTML_TAG_END --></pre>
<h2 id="스벨트킷에서-호출하기"><a href="#스벨트킷에서-호출하기">스벨트킷에서 호출하기</a></h2>
<p>잘 작동하는지 확인을 해보기 위해 임시로 <code>pkg</code> 디렉터리를 복사하여 블로그 프로젝트의
<code>src/lib/blogwasm</code> 디렉터리에 넣습니다.</p>
<p>이제 아무 스벨트 파일에서나 이 라이브러리를 호출할 수 있습니다. 예를 들어
<code>src/routes/test.svelte</code> 파일을 만들고 아래 내용을 추가해보세요.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token punctuation">&#123;</span> onMount <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'svelte'</span>
  <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'$lib/blogwasm'</span>

  <span class="token function">onMount</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> wasm<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    wasm<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token string">'WASM'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<p><code>npm run dev</code> 명령으로 개발 서버를 실행하고 <code>http://localhost:3000/test</code> 주소에
접속하면 “Hello WASM”이라는 얼럿창이 뜨는 것을 확인할 수 있습니다.</p>
<h2 id="자동-배포"><a href="#자동-배포">자동 배포</a></h2>
<p>러스트 프로젝트에서 컴파일을 하고 디렉터리를 수동으로 복사하는 작업을 매번 반복하기엔 귀찮기도
하고 느릴 뿐 아니라 실수를 유발하기도 합니다.</p>
<p><code>npm install</code> 명령은 임의의 URL에 있는 <code>*.tar.gz</code> 파일을 설치할 수 있습니다. 따라서
<code>blogwasm</code> 프로젝트의 빌드 결과물을 <code>blogwasm.tar.gz</code> 파일로 압축하여 인터넷에 올려두는
작업을 자동화하면 문제가 해결됩니다.</p>
<p>npm 레지스트리에 등록하는 방법도 있기는 하지만 개인이 쓰는 패키지를 올리기엔 적절치 않습니다.
이런 상황에서 Github Releases 기능을 활용하면 좋습니다.</p>
<p><code>blogwasm</code> 프로젝트에 <code>.github/workflows/release.yml</code> 파일을 추가합니다.</p>
<pre class="language-yaml"><!-- HTML_TAG_START --><code class="language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> release

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'v*.*.*'</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare build
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> jetli/wasm<span class="token punctuation">-</span>pack<span class="token punctuation">-</span>action@v0.3.0
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'latest'</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build
        <span class="token key atrule">run</span><span class="token punctuation">:</span> wasm<span class="token punctuation">-</span>pack build <span class="token punctuation">-</span><span class="token punctuation">-</span>target web <span class="token important">&amp;&amp;</span> tar <span class="token punctuation">-</span>czvf blogwasm.tar.gz pkg/
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> blogwasm.tar.gz</code><!-- HTML_TAG_END --></pre>
<p>이제 버전 태깅을 한 후에 푸시하면 자동으로 빌드가 실행되고 그 결과가 <code>blogwasm.tar.gz</code>
이라는 파일에 담겨 릴리즈됩니다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash"><span class="token function">git</span> tag -a v0.1.0 -m <span class="token string">"Release v0.1.0"</span>
<span class="token function">git</span> push origin v0.1.0</code><!-- HTML_TAG_END --></pre>
<p>잠시 기다리면 결과물이 릴리즈된 것을 확인할 수 있습니다. 참고로 제 깃헙 저장소의 경우
<a href="https://github.com/gongbughim/blogwasm/releases" rel="nofollow">https://github.com/gongbughim/blogwasm/releases</a> 에서 릴리즈된 결과들을 확인할 수
있습니다.</p>
<p>이제 <code>blog</code> 프로젝트에서 이 파일을 사용하도록 설정합니다.</p>
<pre class="language-bash"><!-- HTML_TAG_START --><code class="language-bash"><span class="token function">npm</span> i -D https://github.com/gongbughim/blogwasm/releases/download/v0.1.2/blogwasm.tar.gz</code><!-- HTML_TAG_END --></pre>
<p>다음으로, 기존 <code>src/routes/test.svelte</code> 파일의 임포트 부분을 <code>$lib/blogwasm</code> 대신
<code>blogwasm</code>으로 수정합니다.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'blogwasm'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<p>원래는 이러면 되어야 하는데, 현재(2022-04-03 기준) vite에 버그가 있어서 아쉽게도 이 부분에서
오류가 발생합니다. 임시로 <code>node_modules/blogwasm</code> 파일을 <code>src/lib/blogwasm</code>으로
복사해주면 문제가 해결됩니다.</p>
<p>이 과정 역시 수작업으로 하면 실수의 여지가 있으니 자동화하면 좋습니다. <code>package.json</code>에
<code>postinstall</code> 스크립트를 추가해줍니다.</p>
<pre class="language-json"><!-- HTML_TAG_START --><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"postinstall"</span><span class="token operator">:</span> <span class="token string">"cp -r ./node_modules/blogwasm ./src/lib/blogwasm"</span><span class="token punctuation">,</span>
    <span class="token property">"..."</span><span class="token operator">:</span> <span class="token string">"..."</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code><!-- HTML_TAG_END --></pre>
<p>외부에서 복사한 파일들이 깃에 커밋되면 안되니까 <code>.gitignore</code> 파일에 다음 한 줄을
추가해줍니다.</p>
<pre class="language-undefined"><!-- HTML_TAG_START --><code class="language-undefined">src/lib/blogwasm/</code><!-- HTML_TAG_END --></pre>
<p>이제 수정했던 임포트 경로만 다시 원래대로 되돌려주면 문제없이 잘 작동합니다.</p>
<pre class="language-svelte"><!-- HTML_TAG_START --><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> wasm <span class="token keyword">from</span> <span class="token string">'$lib/blogwasm'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code><!-- HTML_TAG_END --></pre>
<h2 id="언제-wasm을-쓰나"><a href="#언제-wasm을-쓰나">언제 WASM을 쓰나</a></h2>
<p>여러 성능 테스트를 살펴보면, WASM을 쓴다고 해서 항상 속도가 더 빨라지지는 않습니다. WASM을
쓰기에 가장 이상적인 상황은 이렇습니다.</p>
<ul><li>호출을 하면 WASM 안에서 많은 연산을 수행하는 상황</li>
<li>WASM과 JS 코드 사이의 교류가 적은 상황</li></ul>
<h2 id="마치며"><a href="#마치며">마치며</a></h2>
<p>이 글에서 설명한 코드는 이 블로그에도 적용되어 있습니다.
<a href="https://github.com/gongbughim/blog" rel="nofollow">소스 코드</a>가 공개되어 있으니 참고해주세요. 웹
어셈블리 프로젝트는 <a href="https://github.com/gongbughim/blogwasm" rel="nofollow">별도의 저장소</a>
공개했습니다.</p>
<h2 id="관련-글"><a href="#관련-글">관련 글</a></h2>
<ul><li><a href="/posts/sveltekit-blog" sveltekit:prefetch="sveltekit:prefetch">스벨트킷으로 블로그 만들기</a></li></ul>
</article></main>

<footer class="svelte-1y5881k">Copyright ©2022,
  <a href="https://twitter.com/gongbughim" class="external">Twitter</a> |
  <a href="https://github.com/gongbughim" class="external">Github</a>
</footer>


		<script type="module" data-hydrate="ku0u4t">
		import { start } from "/_app/start-45cd698a.js";
		start({
			target: document.querySelector('[data-hydrate="ku0u4t"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "ignore",
			hydrate: {
				status: 200,
				error: null,
				nodes: [
					import("/_app/pages/__layout.svelte-7800c35d.js"),
						import("/_app/pages/posts/sveltekit-wasm.md-2f5a5957.js")
				],
				params: {},
				routeId: "posts/sveltekit-wasm"
			}
		});
	</script>
  </body>
</html>
